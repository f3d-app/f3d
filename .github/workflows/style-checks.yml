on:
  pull_request_target:
    types: [assigned, opened, synchronize, reopened]
    branches:
      - master
      - release
name: Style Checks
jobs:

  detect:
    runs-on: ubuntu-latest
    outputs:
      checked: ${{ steps.detect.outputs.checked }}
      unchecked: ${{ steps.detect.outputs.unchecked }}

    permissions:
      pull-requests: write

    steps:
      - name: Checkbox Trigger
        id: detect
        uses: a7med3bdulbaset/checklist
        with:
          token: ${{ github.token }}
            
      - name: list changes
        run: |
          echo "checked=${{ steps.detect.outputs.checked }}"
          echo "unchecked=${{ steps.detect.outputs.unchecked }}

  style-checks:
    name: Formatting Check
    runs-on: ubuntu-latest
    needs: [detect]
    if: ${{ contains(needs.detect.outputs.checked, 'format') }}

    env:
      ACCESS_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    steps:

    - uses: actions/checkout@v4
      with:
        ref: ${{github.event.pull_request.head.ref}}
        repository: ${{github.event.pull_request.head.repo.full_name}}

    - name: C++ Formatting
      uses: DoozyX/clang-format-lint-action@v0.16
      with:
        source: '.'
        extensions: 'h,cxx,in'
        exclude: './cmake **/*.py.in **/*.log.in **/*.json.in **/*.thumbnailer.in **/*.cmake.in **/*.desktop.in'
        clangFormatVersion: 18
        inplace: True

    - name: Python Formatting
      uses: psf/black@stable
      with:
        options: "--include '(\\.py|\\.py\\.in)'"

    - name: Prettier Formatting
      continue-on-error: true
      uses: creyD/prettier_action@v4.3
      with:
        dry: True
        prettier_options: '-w **/*.{js,json,md,html}'

    - name: Codespell in place
      shell: bash
      run: |
        pip install codespell
        codespell -fHw .

    - uses: googleapis/code-suggester@v5
      with:
        command: review
        pull_number: ${{ github.event.pull_request.number }}
        git_dir: '.'

    - name: Diff output
      shell: bash
      run: git diff --color=always --exit-code
